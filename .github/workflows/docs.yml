name: Documentation

on:
  push:
    branches: [main, master]
    paths:
      - 'docs/**'
      - 'nepse_client/**'
      - 'README.md'
      - 'CHANGELOG.md'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'docs/**'
      - 'nepse_client/**'
      - 'README.md'
  workflow_dispatch:

# Cancel in-progress runs for the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================
  # Check Documentation Quality
  # ============================================================
  check-docs:
    name: Check Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install sphinx sphinx-rtd-theme sphinx-autodoc-typehints
          pip install -e .

      - name: Check for broken links in README
        run: |
          pip install markdown-link-check || npm install -g markdown-link-check
          markdown-link-check README.md || true
        continue-on-error: true

      - name: Check RST syntax
        run: |
          pip install rstcheck
          find docs -name "*.rst" -exec rstcheck {} \;
        continue-on-error: true

      - name: Validate docstrings
        run: |
          pip install pydocstyle
          pydocstyle nepse_client --convention=google
        continue-on-error: true

  # ============================================================
  # Build Sphinx Documentation
  # ============================================================
  build-sphinx:
    name: Build Sphinx Docs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install sphinx sphinx-rtd-theme sphinx-autodoc-typehints
          pip install sphinx-copybutton sphinxcontrib-napoleon

      - name: Build HTML documentation
        run: |
          cd docs
          make clean
          make html || true
        env:
          SPHINXOPTS: "--keep-going"
        continue-on-error: true

      - name: Check for warnings
        run: |
          cd docs
          make linkcheck || true
        continue-on-error: true

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: documentation-html
          path: docs/_build/html/
          retention-days: 30

      - name: Create documentation archive
        run: |
          cd docs/_build/html
          tar -czf ../../../docs.tar.gz .

      - name: Upload documentation archive
        uses: actions/upload-artifact@v4
        with:
          name: documentation-archive
          path: docs.tar.gz
          retention-days: 30

  # ============================================================
  # Deploy to GitHub Pages
  # ============================================================
  deploy-github-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-sphinx
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download documentation
        uses: actions/download-artifact@v4
        with:
          name: documentation-html
          path: ./docs-html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs-html
          publish_branch: gh-pages
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy documentation from ${{ github.sha }}'

  # ============================================================
  # Build API Reference
  # ============================================================
  build-api-reference:
    name: Build API Reference
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pdoc3

      - name: Generate API documentation with pdoc
        run: |
          python -m pdoc nepse_client --html --output-dir api-docs --force --skip-errors

      - name: Upload API reference
        uses: actions/upload-artifact@v4
        with:
          name: api-reference
          path: api-docs/
          retention-days: 30

  # ============================================================
  # Generate Changelog
  # ============================================================
  generate-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        run: |
          # Install github-changelog-generator or similar
          echo "# Changelog" > CHANGELOG_AUTO.md
          echo "" >> CHANGELOG_AUTO.md
          git log --oneline --decorate --all >> CHANGELOG_AUTO.md

      - name: Upload changelog
        uses: actions/upload-artifact@v4
        with:
          name: auto-changelog
          path: CHANGELOG_AUTO.md
          retention-days: 30

  # ============================================================
  # Check Documentation Coverage
  # ============================================================
  doc-coverage:
    name: Documentation Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install interrogate

      - name: Check docstring coverage
        run: |
          interrogate -v nepse_client \
            --ignore-init-method \
            --ignore-init-module \
            --ignore-magic \
            --fail-under=80 \
            --generate-badge docs/
        continue-on-error: true

      - name: Upload coverage badge
        uses: actions/upload-artifact@v4
        with:
          name: docstring-coverage-badge
          path: docs/interrogate_badge.svg
          retention-days: 30

  # ============================================================
  # Spell Check Documentation
  # ============================================================
  spell-check:
    name: Spell Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install cspell
        run: npm install -g cspell

      - name: Run spell check
        run: |
          cspell "**/*.md" "**/*.rst" "**/*.py" \
            --config .cspell.json \
            || true
        continue-on-error: true

  # ============================================================
  # Documentation Build Status
  # ============================================================
  status:
    name: Documentation Status
    runs-on: ubuntu-latest
    needs: [check-docs, build-sphinx, build-api-reference]
    if: always()

    steps:
      - name: Check job status
        run: |
          if [[ "${{ needs.check-docs.result }}" == "failure" ]] || \
            [[ "${{ needs.build-sphinx.result }}" == "failure" ]]; then
            echo "âŒ Documentation build failed!"
            exit 1
          fi
          echo "âœ… Documentation built successfully!"
        continue-on-error: true

      - name: Create status summary
        run: |
          echo "## ðŸ“š Documentation Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Check Docs**: ${{ needs.check-docs.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Sphinx**: ${{ needs.build-sphinx.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **API Reference**: ${{ needs.build-api-reference.result }}" >> $GITHUB_STEP_SUMMARY

  # ------------------------ DISCORD NOTIFICATION ------------------------
  notify:
    name: Discord Notification
    runs-on: ubuntu-latest
    needs: [status]
    if: always()

    steps:
      - name: Set message based on status
        id: msg
        run: |
          STATUS="${{ needs.status.result }}"
          if [[ "$STATUS" == "success" ]]; then
            echo "color=3066993" >> $GITHUB_OUTPUT  # Green
            echo "result=âœ… Documentation pipeline succeeded!" >> $GITHUB_OUTPUT
          else
            echo "color=15158332" >> $GITHUB_OUTPUT  # Red
            echo "result=âŒ Documentation pipeline failed!" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord Notification
        uses: Ilshidur/action-discord@0.3.2
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embeds: |
            [
              {
                "title": "ðŸ“š Docs CI â€” ${{ github.repository }}",
                "description": "${{ steps.msg.outputs.result }}",
                "color": ${{ steps.msg.outputs.color }},
                "fields": [
                  { "name": "Branch", "value": "${{ github.ref_name }}", "inline": true },
                  { "name": "Commit", "value": "[${{ github.sha }}](${{ github.event.head_commit.url }})", "inline": true },
                  { "name": "Triggered by", "value": "${{ github.actor }}", "inline": true }
                ],
                "footer": {
                  "text": "GitHub Actions Docs Pipeline"
                },
                "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
              }
            ]
